<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæµæ¨¡æ¿ç®¡ç† - è¿ç»´å·¥å•ç³»ç»Ÿ</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .template-card { margin-bottom: 15px; }
        .step-badge { font-size: 0.7em; margin: 1px; }
        .step-container { margin-left: 20px; }
        .parallel-group { border-left: 3px solid #007bff; padding-left: 10px; margin: 5px 0; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">è¿ç»´å·¥å•ç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/dashboard}">æ§åˆ¶é¢æ¿</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/work-orders}">å·¥å•ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/work-order-types}">ç±»å‹ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/departments}">éƒ¨é—¨ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/workflow}">å·¥ä½œæµç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/statistics}">ç»Ÿè®¡æŠ¥è¡¨</a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" th:href="@{/admin/users}">ç”¨æˆ·ç®¡ç†</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <span class="navbar-text me-3">
                        æ¬¢è¿ï¼Œ<span sec:authentication="name">ç”¨æˆ·</span>
                    </span>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="btn btn-outline-light btn-sm">é€€å‡º</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/workflow}">å·¥ä½œæµç®¡ç†</a></li>
                        <li class="breadcrumb-item active">å·¥ä½œæµæ¨¡æ¿</li>
                    </ol>
                </nav>
                <h2>å·¥ä½œæµæ¨¡æ¿ç®¡ç†</h2>
                <p class="text-muted">é…ç½®å¤šå±‚çº§å®¡æ‰¹å·¥ä½œæµæ¨¡æ¿ï¼Œæ”¯æŒå¹¶è¡Œ/ä¸²è¡Œå®¡æ‰¹å’Œè‡ªåŠ¨æµè½¬</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
                    <i class="bi bi-plus-lg"></i> åˆ›å»ºæ¨¡æ¿
                </button>
                <button class="btn btn-success" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- æ¨¡æ¿åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">å·¥ä½œæµæ¨¡æ¿åˆ—è¡¨</h5>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showInactiveTemplates" onchange="toggleInactiveTemplates()">
                            <label class="form-check-label" for="showInactiveTemplates">
                                æ˜¾ç¤ºå·²åœç”¨æ¨¡æ¿
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="templatesList">
                    <!-- æ¨¡æ¿åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨åŠ è½½æ¨¡æ¿æ•°æ®...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºæ¨¡æ¿æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ›å»ºå·¥ä½œæµæ¨¡æ¿</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTemplateForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">æ¨¡æ¿åç§° *</label>
                                <input type="text" class="form-control" name="templateName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">é€‚ç”¨å·¥å•ç±»å‹</label>
                                <select class="form-select" name="workOrderType">
                                    <option value="">é€šç”¨</option>
                                    <option value="EMERGENCY">ğŸš¨ åº”æ€¥å·¥å• - ç´§æ€¥äº‹ä»¶ã€å®‰å…¨äº‹æ•…</option>
                                    <option value="INCIDENT">ğŸ› æ•…éšœå·¥å• - ç³»ç»Ÿæ•…éšœã€æœåŠ¡ä¸­æ–­</option>
                                    <option value="MAINTENANCE">ğŸ”§ ç»´æŠ¤å·¥å• - è®¡åˆ’ç»´æŠ¤ã€ç³»ç»Ÿå‡çº§</option>
                                    <option value="REQUEST">ğŸ’¡ éœ€æ±‚å·¥å• - åŠŸèƒ½éœ€æ±‚ã€é…ç½®å˜æ›´</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ¨¡æ¿æè¿°</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>å®¡æ‰¹æ­¥éª¤é…ç½®</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addStep()">
                                <i class="bi bi-plus"></i> æ·»åŠ æ­¥éª¤
                            </button>
                        </div>
                        <div id="stepsContainer">
                            <!-- æ­¥éª¤å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                        </div>
                        <div class="text-center mt-3" id="noStepsMessage">
                            <p class="text-muted">æš‚æ— æ­¥éª¤ï¼Œè¯·ç‚¹å‡»"æ·»åŠ æ­¥éª¤"æŒ‰é’®æ·»åŠ å·¥ä½œæµæ­¥éª¤</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createTemplate()">åˆ›å»ºæ¨¡æ¿</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script>
        let templates = [];
        let stepCounter = 0;
        
        // é¡µé¢åŠ è½½å®Œæˆåè·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplates();
        });

        // åŠ è½½æ¨¡æ¿åˆ—è¡¨
        function loadTemplates() {
            // å…ˆå°è¯•ç®€åŒ–ç‰ˆæœ¬
            fetch('/api/workflow-templates/simple')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('è·å–åˆ°çš„ç®€åŒ–æ¨¡æ¿æ•°æ®:', data);
                    if (data && data.length > 0 && data[0].error) {
                        throw new Error(data[0].error);
                    }
                    templates = data || [];
                    renderSimpleTemplates(templates);
                })
                .catch(error => {
                    console.error('Error loading simple templates:', error);
                    // å¦‚æœç®€åŒ–ç‰ˆæœ¬å¤±è´¥ï¼Œå°è¯•å®Œæ•´ç‰ˆæœ¬
                    loadFullTemplates();
                });
        }
        
        // åŠ è½½å®Œæ•´æ¨¡æ¿åˆ—è¡¨
        function loadFullTemplates() {
            fetch('/api/workflow-templates')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('è·å–åˆ°çš„å®Œæ•´æ¨¡æ¿æ•°æ®:', data);
                    templates = data || [];
                    renderTemplates(templates);
                })
                .catch(error => {
                    console.error('Error loading templates:', error);
                    document.getElementById('templatesList').innerHTML = 
                        `<div class="alert alert-danger">
                            <h6>åŠ è½½æ¨¡æ¿æ•°æ®å¤±è´¥</h6>
                            <p class="mb-0">é”™è¯¯: ${error.message}</p>
                            <button class="btn btn-sm btn-outline-danger mt-2" onclick="loadTemplates()">é‡è¯•</button>
                            <button class="btn btn-sm btn-outline-info mt-2" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                        </div>`;
                });
        }
        
        // æµ‹è¯•è¿æ¥
        function testConnection() {
            fetch('/api/workflow-templates/count')
                .then(response => response.text())
                .then(data => {
                    alert('è¿æ¥æµ‹è¯•ç»“æœ: ' + data);
                })
                .catch(error => {
                    alert('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                });
        }

        // æ¸²æŸ“ç®€åŒ–æ¨¡æ¿åˆ—è¡¨
        function renderSimpleTemplates(templateList) {
            const container = document.getElementById('templatesList');
            const showInactive = document.getElementById('showInactiveTemplates').checked;
            
            console.log('æ¸²æŸ“ç®€åŒ–æ¨¡æ¿åˆ—è¡¨ï¼š');
            console.log('- æ˜¾ç¤ºå·²åœç”¨æ¨¡æ¿å¼€å…³çŠ¶æ€:', showInactive);
            console.log('- æ€»æ¨¡æ¿æ•°:', templateList.length);
            console.log('- æ¨¡æ¿è¯¦æƒ…:', templateList.map(t => ({ name: t.templateName, active: t.isActive })));
            
            const filteredTemplates = showInactive ? templateList : templateList.filter(t => t.isActive);
            
            console.log('- è¿‡æ»¤åæ¨¡æ¿æ•°:', filteredTemplates.length);
            
            if (!filteredTemplates || filteredTemplates.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— æ¨¡æ¿æ•°æ®</div>';
                return;
            }

            let html = '';
            filteredTemplates.forEach(template => {
                const statusBadge = template.isActive ? 
                    '<span class="badge bg-success">å¯ç”¨</span>' : 
                    '<span class="badge bg-secondary">åœç”¨</span>';
                
                html += `
                    <div class="card template-card">
                        <div class="card-body">
                            <div class="row align-items-start">
                                <div class="col-md-6">
                                    <h6 class="card-title mb-1">
                                        ${template.templateName} ${statusBadge}
                                    </h6>
                                    <p class="text-muted mb-1">${template.description || 'æ— æè¿°'}</p>
                                    <small class="text-muted">
                                        å·¥å•ç±»å‹: ${template.workOrderType || 'é€šç”¨'}
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <div class="step-container">
                                        <small class="text-muted">æ­¥éª¤æ•°é‡: ${template.stepCount || 0}</small>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <div class="btn-group-vertical btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info" onclick="viewTemplate(${template.id})">
                                            <i class="bi bi-eye"></i> æŸ¥çœ‹
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="editTemplate(${template.id})">
                                            <i class="bi bi-pencil"></i> ç¼–è¾‘
                                        </button>
                                        <button type="button" class="btn ${template.isActive ? 'btn-outline-secondary' : 'btn-outline-success'}" 
                                                onclick="toggleTemplate(${template.id}, ${template.isActive})">
                                            <i class="bi ${template.isActive ? 'bi-pause' : 'bi-play'}"></i> 
                                            ${template.isActive ? 'åœç”¨' : 'å¯ç”¨'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨
        function renderTemplates(templateList) {
            const container = document.getElementById('templatesList');
            const showInactive = document.getElementById('showInactiveTemplates').checked;
            
            const filteredTemplates = showInactive ? templateList : templateList.filter(t => t.isActive);
            
            if (!filteredTemplates || filteredTemplates.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— æ¨¡æ¿æ•°æ®</div>';
                return;
            }

            let html = '';
            filteredTemplates.forEach(template => {
                const statusBadge = template.isActive ? 
                    '<span class="badge bg-success">å¯ç”¨</span>' : 
                    '<span class="badge bg-secondary">åœç”¨</span>';
                
                html += `
                    <div class="card template-card">
                        <div class="card-body">
                            <div class="row align-items-start">
                                <div class="col-md-4">
                                    <h6 class="card-title mb-1">
                                        ${template.templateName} ${statusBadge}
                                    </h6>
                                    <p class="text-muted mb-1">${template.description || 'æ— æè¿°'}</p>
                                    <small class="text-muted">
                                        å·¥å•ç±»å‹: ${template.workOrderType || 'é€šç”¨'}
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <div class="step-container">
                                        <small class="text-muted">å®¡æ‰¹æµç¨‹:</small>
                                        ${renderStepsPreview(template.steps || [])}
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button class="btn btn-sm btn-outline-info" onclick="viewTemplate(${template.id})">
                                        <i class="bi bi-eye"></i> è¯¦æƒ…
                                    </button>
                                    <br>
                                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="editTemplate(${template.id})">
                                        <i class="bi bi-pencil"></i> ç¼–è¾‘
                                    </button>
                                    <br>
                                    <button class="btn btn-sm ${template.isActive ? 'btn-outline-warning' : 'btn-outline-success'} mt-1" 
                                            onclick="toggleTemplate(${template.id}, ${template.isActive})">
                                        <i class="bi bi-${template.isActive ? 'pause' : 'play'}"></i> 
                                        ${template.isActive ? 'åœç”¨' : 'å¯ç”¨'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // æ¸²æŸ“æ­¥éª¤é¢„è§ˆ
        function renderStepsPreview(steps) {
            if (!steps || steps.length === 0) {
                return '<span class="text-muted">æ— æ­¥éª¤</span>';
            }

            let html = '<div class="d-flex flex-wrap">';
            steps.forEach((step, index) => {
                const badgeClass = step.isParallel ? 'bg-info' : 'bg-primary';
                html += `
                    <span class="step-badge badge ${badgeClass}" title="${getStepTypeName(step.stepType)}">
                        ${index + 1}. ${step.stepName}
                        ${step.timeLimitHours ? `(${step.timeLimitHours}h)` : ''}
                    </span>
                `;
                if (index < steps.length - 1) {
                    html += '<i class="bi bi-arrow-right mx-1"></i>';
                }
            });
            html += '</div>';
            return html;
        }

        // è·å–æ­¥éª¤ç±»å‹ä¸­æ–‡å
        function getStepTypeName(type) {
            const types = {
                'DEPARTMENT_REVIEW': 'éƒ¨é—¨åˆå®¡',
                'MANAGER_APPROVAL': 'ç»ç†å®¡æ‰¹',
                'DIRECTOR_APPROVAL': 'ä¸»ç®¡å®¡æ‰¹',
                'EXECUTION': 'æ‰§è¡Œæ“ä½œ',
                'VERIFICATION': 'éªŒè¯ç¡®è®¤',
                'COMPLETION': 'å®Œæˆç¡®è®¤'
            };
            return types[type] || type;
        }

        // åˆ‡æ¢æ˜¾ç¤ºéæ´»è·ƒæ¨¡æ¿
        function toggleInactiveTemplates() {
            // æ ¹æ®å½“å‰ä½¿ç”¨çš„æ¸²æŸ“æ–¹å¼æ¥å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
            if (templates.length > 0 && templates[0].stepCount !== undefined) {
                // ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬æ¸²æŸ“
                renderSimpleTemplates(templates);
            } else {
                // ä½¿ç”¨å®Œæ•´ç‰ˆæœ¬æ¸²æŸ“
                renderTemplates(templates);
            }
        }

        // æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…
        function viewTemplate(templateId) {
            window.location.href = `/workflow/templates/${templateId}`;
        }

        // ç¼–è¾‘æ¨¡æ¿
        function editTemplate(templateId) {
            // TODO: å®ç°ç¼–è¾‘åŠŸèƒ½
            alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // åˆ‡æ¢æ¨¡æ¿çŠ¶æ€
        function toggleTemplate(templateId, currentStatus) {
            const action = currentStatus ? 'åœç”¨' : 'å¯ç”¨';
            if (confirm(`ç¡®å®šè¦${action}è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ`)) {
                // ä½¿ç”¨ä¸“é—¨çš„çŠ¶æ€åˆ‡æ¢API
                const endpoint = currentStatus ? 
                    `/api/workflow-templates/${templateId}/disable` : 
                    `/api/workflow-templates/${templateId}/enable`;
                
                fetch(endpoint, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('å“åº”çŠ¶æ€:', response.status);
                    if (response.ok) {
                        alert(`${action}æˆåŠŸ`);
                        loadTemplates();
                    } else {
                        return response.text().then(text => {
                            console.error('æœåŠ¡å™¨é”™è¯¯å“åº”:', text);
                            alert(`${action}å¤±è´¥: HTTP ${response.status}\n${text}`);
                        });
                    }
                })
                .catch(error => {
                    console.error('è¯·æ±‚é”™è¯¯:', error);
                    alert(`${action}å¤±è´¥: ${error.message}`);
                });
            }
        }

        // æ·»åŠ æ­¥éª¤
        function addStep() {
            stepCounter++;
            // éšè—ç©ºæç¤ºä¿¡æ¯
            const noStepsMessage = document.getElementById('noStepsMessage');
            if (noStepsMessage) {
                noStepsMessage.style.display = 'none';
            }
            
            const stepHtml = `
                <div class="card mb-3" id="step-${stepCounter}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">æ­¥éª¤ ${stepCounter}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep(${stepCounter})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">æ­¥éª¤åç§° *</label>
                                <input type="text" class="form-control" name="steps[${stepCounter}][stepName]" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">æ­¥éª¤ç±»å‹ *</label>
                                <select class="form-select" name="steps[${stepCounter}][stepType]" required>
                                    <option value="DEPARTMENT_REVIEW">éƒ¨é—¨åˆå®¡</option>
                                    <option value="MANAGER_APPROVAL">ç»ç†å®¡æ‰¹</option>
                                    <option value="DIRECTOR_APPROVAL">ä¸»ç®¡å®¡æ‰¹</option>
                                    <option value="EXECUTION">æ‰§è¡Œæ“ä½œ</option>
                                    <option value="VERIFICATION">éªŒè¯ç¡®è®¤</option>
                                    <option value="COMPLETION">å®Œæˆç¡®è®¤</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">å¤„ç†äººè§’è‰²</label>
                                <select class="form-select" name="steps[${stepCounter}][assigneeRole]">
                                    <option value="">è‡ªåŠ¨åˆ†é…</option>
                                    <option value="ADMIN">ç®¡ç†å‘˜</option>
                                    <option value="MANAGER">ç»ç†</option>
                                    <option value="OPERATOR">æ“ä½œå‘˜</option>
                                    <option value="USER">ç”¨æˆ·</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">æ—¶é™(å°æ—¶)</label>
                                <input type="number" class="form-control" name="steps[${stepCounter}][timeLimitHours]" min="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å¹¶è¡Œç»„</label>
                                <input type="number" class="form-control" name="steps[${stepCounter}][parallelGroup]" min="1">
                                <small class="form-text text-muted">ç›¸åŒç»„çš„æ­¥éª¤å¹¶è¡Œæ‰§è¡Œ</small>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="steps[${stepCounter}][isSkippable]">
                                    <label class="form-check-label">å¯è·³è¿‡</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="steps[${stepCounter}][autoApprove]">
                                    <label class="form-check-label">è¶…æ—¶è‡ªåŠ¨é€šè¿‡</label>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="steps[${stepCounter}][stepOrder]" value="${stepCounter}">
                    </div>
                </div>
            `;
            document.getElementById('stepsContainer').insertAdjacentHTML('beforeend', stepHtml);
        }

        // ç§»é™¤æ­¥éª¤
        function removeStep(stepId) {
            document.getElementById(`step-${stepId}`).remove();
            
            // å¦‚æœæ²¡æœ‰æ­¥éª¤äº†ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const stepElements = document.querySelectorAll('#stepsContainer .card');
            const noStepsMessage = document.getElementById('noStepsMessage');
            if (stepElements.length === 0 && noStepsMessage) {
                noStepsMessage.style.display = 'block';
            }
        }

        // åˆ›å»ºæ¨¡æ¿
        function createTemplate() {
            const form = document.getElementById('createTemplateForm');
            const formData = new FormData(form);
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const templateName = formData.get('templateName');
            if (!templateName || templateName.trim() === '') {
                alert('è¯·è¾“å…¥æ¨¡æ¿åç§°');
                return;
            }
            
            // æ„å»ºæ¨¡æ¿å¯¹è±¡
            const template = {
                templateName: templateName.trim(),
                description: formData.get('description') || '',
                workOrderType: formData.get('workOrderType') || null,
                steps: []
            };

            // æ”¶é›†æ­¥éª¤æ•°æ®
            const stepElements = document.querySelectorAll('#stepsContainer .card');
            
            if (stepElements.length === 0) {
                alert('è‡³å°‘éœ€è¦æ·»åŠ ä¸€ä¸ªæ­¥éª¤');
                return;
            }

            let hasError = false;
            stepElements.forEach((stepElement, index) => {
                const step = { stepOrder: index + 1 };
                
                // è·å–æ­¥éª¤åç§°
                const stepNameInput = stepElement.querySelector('input[name*="[stepName]"]');
                if (!stepNameInput || !stepNameInput.value.trim()) {
                    alert(`æ­¥éª¤ ${index + 1} çš„åç§°ä¸èƒ½ä¸ºç©º`);
                    hasError = true;
                    return;
                }
                step.stepName = stepNameInput.value.trim();
                
                // è·å–æ­¥éª¤ç±»å‹
                const stepTypeSelect = stepElement.querySelector('select[name*="[stepType]"]');
                if (!stepTypeSelect || !stepTypeSelect.value) {
                    alert(`æ­¥éª¤ ${index + 1} çš„ç±»å‹ä¸èƒ½ä¸ºç©º`);
                    hasError = true;
                    return;
                }
                step.stepType = stepTypeSelect.value;
                
                // è·å–å¤„ç†äººè§’è‰²
                const assigneeRoleSelect = stepElement.querySelector('select[name*="[assigneeRole]"]');
                step.assigneeRole = assigneeRoleSelect ? assigneeRoleSelect.value || null : null;
                
                // è·å–æ—¶é™
                const timeLimitInput = stepElement.querySelector('input[name*="[timeLimitHours]"]');
                step.timeLimitHours = timeLimitInput && timeLimitInput.value ? parseInt(timeLimitInput.value) : null;
                
                // è·å–å¹¶è¡Œç»„
                const parallelGroupInput = stepElement.querySelector('input[name*="[parallelGroup]"]');
                step.parallelGroup = parallelGroupInput && parallelGroupInput.value ? parseInt(parallelGroupInput.value) : null;
                
                // è·å–æ˜¯å¦å¯è·³è¿‡
                const isSkippableCheckbox = stepElement.querySelector('input[name*="[isSkippable]"]');
                step.isSkippable = isSkippableCheckbox ? isSkippableCheckbox.checked : false;
                
                // è·å–è‡ªåŠ¨é€šè¿‡
                const autoApproveCheckbox = stepElement.querySelector('input[name*="[autoApprove]"]');
                step.autoApprove = autoApproveCheckbox ? autoApproveCheckbox.checked : false;
                
                // è®¾ç½®å¹¶è¡Œæ ‡å¿—
                step.isParallel = step.parallelGroup ? true : false;
                
                template.steps.push(step);
            });

            if (hasError) {
                return;
            }

            console.log('å‡†å¤‡æäº¤çš„æ¨¡æ¿æ•°æ®:', template);

            // æäº¤æ¨¡æ¿
            fetch('/api/workflow-templates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(template)
            })
            .then(response => {
                console.log('æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);
                if (response.ok) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        console.error('æœåŠ¡å™¨é”™è¯¯å“åº”:', text);
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
            })
            .then(data => {
                console.log('æ¨¡æ¿åˆ›å»ºæˆåŠŸ:', data);
                bootstrap.Modal.getInstance(document.getElementById('createTemplateModal')).hide();
                form.reset();
                document.getElementById('stepsContainer').innerHTML = '';
                stepCounter = 0;
                loadTemplates();
                alert('æ¨¡æ¿åˆ›å»ºæˆåŠŸ');
            })
            .catch(error => {
                console.error('åˆ›å»ºæ¨¡æ¿å¤±è´¥:', error);
                alert('åˆ›å»ºæ¨¡æ¿å¤±è´¥: ' + error.message);
            });
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadTemplates();
        }
    </script>
</body>
</html> 