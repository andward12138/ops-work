<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨é—¨æ•ˆç‡åˆ†æ - è¿ç»´å·¥å•ç³»ç»Ÿ</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { height: 400px; }
        .efficiency-card { transition: transform 0.2s; }
        .efficiency-card:hover { transform: translateY(-2px); }
        .rank-1 { border-left: 4px solid #ffd700; }
        .rank-2 { border-left: 4px solid #c0c0c0; }
        .rank-3 { border-left: 4px solid #cd7f32; }
        .rank-other { border-left: 4px solid #6c757d; }
        .efficiency-excellent { color: #198754; font-weight: bold; }
        .efficiency-good { color: #0d6efd; }
        .efficiency-average { color: #fd7e14; }
        .efficiency-poor { color: #dc3545; }
        .progress-thin { height: 8px; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">è¿ç»´å·¥å•ç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/dashboard}">æ§åˆ¶é¢æ¿</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/work-orders}">å·¥å•ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/departments}">éƒ¨é—¨ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/workflow}">å·¥ä½œæµç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/statistics}">ç»Ÿè®¡æŠ¥è¡¨</a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" th:href="@{/admin/users}">ç”¨æˆ·ç®¡ç†</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <span class="navbar-text me-3">
                        æ¬¢è¿ï¼Œ<span sec:authentication="name">ç”¨æˆ·</span>
                    </span>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="btn btn-outline-light btn-sm">é€€å‡º</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/statistics}">ç»Ÿè®¡æŠ¥è¡¨</a></li>
                <li class="breadcrumb-item active">éƒ¨é—¨æ•ˆç‡åˆ†æ</li>
            </ol>
        </nav>

        <!-- é¡µé¢æ ‡é¢˜å’Œæ—¥æœŸé€‰æ‹©å™¨ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="bi bi-graph-up-arrow me-2"></i>éƒ¨é—¨æ•ˆç‡åˆ†æ</h2>
                <p class="text-muted">åˆ†æå„éƒ¨é—¨å·¥å•å¤„ç†æ•ˆç‡ï¼Œè¯†åˆ«ä¼˜ç§€å®è·µå’Œæ”¹è¿›æœºä¼š</p>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <form method="get" th:action="@{/statistics/department-efficiency}">
                            <div class="row g-2">
                                <div class="col-md-5">
                                    <label class="form-label small">å¼€å§‹æ—¥æœŸ</label>
                                    <input type="date" class="form-control form-control-sm" name="startDate" 
                                           th:value="${startDate}" required>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label small">ç»“æŸæ—¥æœŸ</label>
                                    <input type="date" class="form-control form-control-sm" name="endDate" 
                                           th:value="${endDate}" required>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary btn-sm">æŸ¥è¯¢</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•´ä½“ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="row mb-4" th:if="${efficiencyStats != null and !efficiencyStats.empty}">
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h6 class="card-title">ä¼˜ç§€éƒ¨é—¨</h6>
                        <h3 th:text="${excellentCount}">0</h3>
                        <small>æ•ˆç‡ â‰¥ 90%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h6 class="card-title">è‰¯å¥½éƒ¨é—¨</h6>
                        <h3 th:text="${goodCount}">0</h3>
                        <small>80% â‰¤ æ•ˆç‡ < 90%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h6 class="card-title">ä¸€èˆ¬éƒ¨é—¨</h6>
                        <h3 th:text="${averageCount}">0</h3>
                        <small>70% â‰¤ æ•ˆç‡ < 80%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <h6 class="card-title">å¾…æ”¹è¿›éƒ¨é—¨</h6>
                        <h3 th:text="${poorCount}">0</h3>
                        <small>æ•ˆç‡ < 70%</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•ˆç‡å›¾è¡¨ -->
        <div class="row mb-4" th:if="${efficiencyStats != null and !efficiencyStats.empty}">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>éƒ¨é—¨æ•ˆç‡å¯¹æ¯”</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="efficiencyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>æ•ˆç‡åˆ†å¸ƒ</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- éƒ¨é—¨æ•ˆç‡æ’è¡Œæ¦œ -->
        <div class="card mb-4" th:if="${efficiencyStats != null and !efficiencyStats.empty}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>éƒ¨é—¨æ•ˆç‡æ’è¡Œæ¦œ</h5>
                <a th:href="@{'/statistics/export/department-efficiency?startDate=' + ${startDate} + '&endDate=' + ${endDate}}" 
                   class="btn btn-success btn-sm">
                    <i class="bi bi-file-earmark-excel me-1"></i>å¯¼å‡ºExcel
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4" th:each="dept, iterStat : ${efficiencyStats}">
                        <div class="card efficiency-card"
                             th:classappend="${iterStat.index == 0} ? 'rank-1' : 
                                           (${iterStat.index == 1} ? 'rank-2' : 
                                           (${iterStat.index == 2} ? 'rank-3' : 'rank-other'))">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="card-title mb-1">
                                            <span class="badge rounded-pill me-2"
                                                  th:classappend="${iterStat.index == 0} ? 'bg-warning' : 
                                                                 (${iterStat.index == 1} ? 'bg-secondary' : 
                                                                 (${iterStat.index == 2} ? 'bg-warning text-dark' : 'bg-light text-dark'))"
                                                  th:text="${iterStat.index + 1}">1</span>
                                            <span th:text="${dept.departmentName}">éƒ¨é—¨åç§°</span>
                                        </h6>
                                        <p class="text-muted mb-0 small">
                                            å·¥å•æ€»æ•°: <span th:text="${dept.totalWorkOrders}">0</span> | 
                                            å·²å®Œæˆ: <span th:text="${dept.completedWorkOrders}">0</span>
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <h5 class="mb-1" 
                                            th:classappend="${dept.efficiency >= 90} ? 'efficiency-excellent' : 
                                                           (${dept.efficiency >= 80} ? 'efficiency-good' : 
                                                           (${dept.efficiency >= 70} ? 'efficiency-average' : 'efficiency-poor'))"
                                            th:text="${#numbers.formatDecimal(dept.efficiency, 1, 1)} + '%'">0.0%</h5>
                                        <small class="text-muted">æ•ˆç‡æŒ‡æ•°</small>
                                    </div>
                                </div>
                                
                                <!-- æ•ˆç‡è¿›åº¦æ¡ -->
                                <div class="progress progress-thin mb-2">
                                    <div class="progress-bar" 
                                         th:classappend="${dept.efficiency >= 90} ? 'bg-success' : 
                                                        (${dept.efficiency >= 80} ? 'bg-primary' : 
                                                        (${dept.efficiency >= 70} ? 'bg-warning' : 'bg-danger'))"
                                         role="progressbar" 
                                         th:style="'width: ' + ${dept.efficiency} + '%'"
                                         th:aria-valuenow="${dept.efficiency}">
                                    </div>
                                </div>
                                
                                <!-- è¯¦ç»†æŒ‡æ ‡ -->
                                <div class="row small">
                                    <div class="col-6">
                                        <div class="d-flex justify-content-between">
                                            <span>å®Œæˆç‡:</span>
                                            <span class="fw-bold" th:text="${#numbers.formatDecimal(dept.completionRate, 1, 1)} + '%'">0.0%</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>è¶…æ—¶å·¥å•:</span>
                                            <span class="fw-bold" th:text="${dept.overdueWorkOrders}">0</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex justify-content-between">
                                            <span>å¹³å‡æ—¶é•¿:</span>
                                            <span class="fw-bold" th:text="${dept.averageResolutionTime > 0 ? #numbers.formatDecimal(dept.averageResolutionTime, 1, 1) + 'h' : '-'}">-</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>æ•ˆç‡ç­‰çº§:</span>
                                            <span class="fw-bold" th:text="${dept.efficiencyLevel}">ä¸€èˆ¬</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- éƒ¨é—¨æ ‡ç­¾ -->
                                <div class="mt-2">
                                    <span th:if="${dept.efficiency >= 90}" class="badge bg-success">ğŸ† ä¼˜ç§€</span>
                                    <span th:if="${dept.efficiency >= 80 && dept.efficiency < 90}" class="badge bg-primary">ğŸ‘ è‰¯å¥½</span>
                                    <span th:if="${dept.efficiency >= 70 && dept.efficiency < 80}" class="badge bg-warning">âš ï¸ ä¸€èˆ¬</span>
                                    <span th:if="${dept.efficiency < 70}" class="badge bg-danger">ğŸ“ˆ å¾…æ”¹è¿›</span>
                                    
                                    <span th:if="${iterStat.index == 0}" class="badge bg-warning text-dark ms-1">ğŸ¥‡ å† å†›</span>
                                    <span th:if="${iterStat.index == 1}" class="badge bg-secondary ms-1">ğŸ¥ˆ äºšå†›</span>
                                    <span th:if="${iterStat.index == 2}" class="badge bg-warning text-dark ms-1">ğŸ¥‰ å­£å†›</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•ˆç‡åˆ†æè¯´æ˜ -->
        <div class="card" th:if="${efficiencyStats != null and !efficiencyStats.empty}">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>æ•ˆç‡è®¡ç®—è¯´æ˜</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>è¯„åˆ†ç®—æ³•</h6>
                        <ul class="list-unstyled">
                            <li>â€¢ <strong>å®Œæˆç‡</strong> (40%æƒé‡): å·²å®Œæˆå·¥å• / æ€»å·¥å•æ•°</li>
                            <li>â€¢ <strong>åŠæ—¶ç‡</strong> (30%æƒé‡): æŒ‰æ—¶å®Œæˆå·¥å• / å·²å®Œæˆå·¥å•</li>
                            <li>â€¢ <strong>å¤„ç†é€Ÿåº¦</strong> (20%æƒé‡): åŸºäºå¹³å‡å¤„ç†æ—¶é—´è®¡ç®—</li>
                            <li>â€¢ <strong>è´¨é‡è¯„åˆ†</strong> (10%æƒé‡): åŸºäºè¿”å·¥ç‡å’Œå®¢æˆ·æ»¡æ„åº¦</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>ç­‰çº§æ ‡å‡†</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-success me-2">ä¼˜ç§€</span> æ•ˆç‡æŒ‡æ•° â‰¥ 90%ï¼Œè¡Œä¸šé¢†å…ˆæ°´å¹³</li>
                            <li><span class="badge bg-primary me-2">è‰¯å¥½</span> 80% â‰¤ æ•ˆç‡æŒ‡æ•° < 90%ï¼Œè¡¨ç°è‰¯å¥½</li>
                            <li><span class="badge bg-warning me-2">ä¸€èˆ¬</span> 70% â‰¤ æ•ˆç‡æŒ‡æ•° < 80%ï¼Œç¬¦åˆæ ‡å‡†</li>
                            <li><span class="badge bg-danger me-2">å¾…æ”¹è¿›</span> æ•ˆç‡æŒ‡æ•° < 70%ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ— æ•°æ®æç¤º -->
        <div class="text-center" th:if="${efficiencyStats == null or efficiencyStats.empty}">
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                æ‰€é€‰æ—¥æœŸèŒƒå›´å†…æš‚æ— éƒ¨é—¨æ•ˆç‡æ•°æ®
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const efficiencyStats = /*[[${efficiencyStats}]]*/ [];
            
            if (efficiencyStats && efficiencyStats.length > 0) {
                // æ•ˆç‡å¯¹æ¯”æŸ±çŠ¶å›¾
                const ctx1 = document.getElementById('efficiencyChart').getContext('2d');
                const departmentNames = efficiencyStats.map(dept => dept.departmentName);
                const efficiencyData = efficiencyStats.map(dept => dept.efficiency);
                const completionRateData = efficiencyStats.map(dept => dept.completionRate);
                
                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: departmentNames,
                        datasets: [{
                            label: 'æ•ˆç‡æŒ‡æ•°',
                            data: efficiencyData,
                            backgroundColor: efficiencyData.map(value => 
                                value >= 90 ? 'rgba(25, 135, 84, 0.8)' :
                                value >= 80 ? 'rgba(13, 110, 253, 0.8)' :
                                value >= 70 ? 'rgba(255, 193, 7, 0.8)' :
                                'rgba(220, 53, 69, 0.8)'
                            ),
                            borderColor: efficiencyData.map(value => 
                                value >= 90 ? 'rgba(25, 135, 84, 1)' :
                                value >= 80 ? 'rgba(13, 110, 253, 1)' :
                                value >= 70 ? 'rgba(255, 193, 7, 1)' :
                                'rgba(220, 53, 69, 1)'
                            ),
                            borderWidth: 1
                        }, {
                            label: 'å®Œæˆç‡',
                            data: completionRateData,
                            type: 'line',
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'éƒ¨é—¨æ•ˆç‡ç»¼åˆå¯¹æ¯”'
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'æ•ˆç‡æŒ‡æ•° (%)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: false,
                                position: 'right',
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });

                // æ•ˆç‡åˆ†å¸ƒé¥¼å›¾
                const ctx2 = document.getElementById('distributionChart').getContext('2d');
                const excellentCount = efficiencyStats.filter(dept => dept.efficiency >= 90).length;
                const goodCount = efficiencyStats.filter(dept => dept.efficiency >= 80 && dept.efficiency < 90).length;
                const averageCount = efficiencyStats.filter(dept => dept.efficiency >= 70 && dept.efficiency < 80).length;
                const poorCount = efficiencyStats.filter(dept => dept.efficiency < 70).length;
                
                new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['ä¼˜ç§€ (â‰¥90%)', 'è‰¯å¥½ (80-89%)', 'ä¸€èˆ¬ (70-79%)', 'å¾…æ”¹è¿› (<70%)'],
                        datasets: [{
                            data: [excellentCount, goodCount, averageCount, poorCount],
                            backgroundColor: [
                                'rgba(25, 135, 84, 0.8)',
                                'rgba(13, 110, 253, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)'
                            ],
                            borderColor: [
                                'rgba(25, 135, 84, 1)',
                                'rgba(13, 110, 253, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'éƒ¨é—¨æ•ˆç‡ç­‰çº§åˆ†å¸ƒ'
                            },
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html> 